<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Coinflip Demo</title>
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.6.0.min.js"></script>

<style>
body{margin:0;background:#020617;color:white;font-family:Arial}
#top{height:60px;border-bottom:1px solid #1e293b;display:flex;justify-content:space-between;align-items:center;padding:0 20px}
#container{display:flex;height:calc(100vh - 60px)}
#chat{width:30%;border-right:1px solid #1e293b;display:flex;flex-direction:column}
#messages{flex:1;overflow:auto;padding:10px}
#chat input{padding:10px;border:none}
#main{width:70%;padding:20px}
.match{border:1px solid #1e293b;padding:10px;border-radius:8px;margin-bottom:10px}
button{background:#2563eb;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
button.red{background:#dc2626}

.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center}
.modal{background:#020617;border:1px solid #1e293b;border-radius:10px;padding:20px;width:300px}

.coin{
  width:140px;height:140px;border-radius:50%;
  background:linear-gradient(145deg,#fde047,#eab308);
  color:black;font-size:48px;
  display:flex;align-items:center;justify-content:center;
  margin:auto;
  animation:flip 2.5s ease-in-out;
}
@keyframes flip{
  0%{transform:rotateY(0)}
  50%{transform:rotateY(720deg) scale(1.2)}
  100%{transform:rotateY(1080deg)}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBg" class="modal-bg" style="display:flex">
  <div class="modal">
    <h3>Login</h3>
    <input id="loginName" placeholder="Username" style="width:100%;padding:8px">
    <br><br>
    <button onclick="login()">Login</button>
  </div>
</div>

<div id="top">
  <div id="userLabel"></div>
  <div>
    <button onclick="createMatch()">Create Match</button>
    <button class="red" onclick="logout()">Logout</button>
  </div>
</div>

<div id="container">
  <div id="chat">
    <div id="messages"></div>
    <input id="chatInput" placeholder="Mesaj yaz...">
  </div>
  <div id="main">
    <h2>Matches</h2>
    <div id="matches"></div>
    <div id="coinflip"></div>
  </div>
</div>

<script>
/* PUBNUB */
const pubnub = new PubNub({
  publishKey: "pub-c-59b96e01-f4ca-486b-bde1-e3160adbc839",
  subscribeKey: "sub-c-3f46e9b1-23c3-4f38-8370-50666a4f1e57",
  uuid: "u" + Math.random()
});

/* STATE */
let user = localStorage.getItem("user");
let matches = {};

/* LOGIN */
if(user){
  loginBg.style.display="none";
  userLabel.innerText=user;
}else{
  top.style.display="none";
  container.style.display="none";
}

function login(){
  user = loginName.value.trim();
  if(!user) return;
  localStorage.setItem("user",user);
  location.reload();
}
function logout(){
  localStorage.clear();
  location.reload();
}

/* SUBSCRIBE */
pubnub.subscribe({channels:["chat","matches"]});

/* LISTENER */
pubnub.addListener({
  message:e=>{
    if(e.channel==="chat"){
      messages.innerHTML += `<div><b>${e.message.u}:</b> ${e.message.t}</div>`;
    }
    if(e.channel==="matches"){
      if(e.message.type==="create") matches[e.message.id]=e.message;
      if(e.message.type==="remove") delete matches[e.message.id];
      renderMatches();
    }
    if(e.channel.startsWith("match-")){
      coinflip.innerHTML = `
        <div class="coin">${e.message.r}</div>
        <h2>${e.message.w} WON</h2>`;
    }
  }
});

/* HISTORY */
pubnub.history({channel:"chat",count:50},(_,r)=>{
  r.messages.forEach(m=>{
    messages.innerHTML += `<div><b>${m.entry.u}:</b> ${m.entry.t}</div>`;
  });
});
pubnub.history({channel:"matches",count:50},(_,r)=>{
  r.messages.forEach(m=>{
    if(m.entry.type==="create") matches[m.entry.id]=m.entry;
    if(m.entry.type==="remove") delete matches[m.entry.id];
  });
  renderMatches();
});

/* CHAT SEND */
chatInput.onkeypress=e=>{
  if(e.key==="Enter"){
    pubnub.publish({channel:"chat",message:{u:user,t:e.target.value}});
    e.target.value="";
  }
};

/* CREATE MATCH */
function createMatch(){
  const id = Date.now();
  pubnub.publish({
    channel:"matches",
    message:{type:"create",id,creator:user}
  });
}

/* RENDER MATCHES (HATA BURADAYDI → DÜZELTİLDİ) */
function renderMatches(){
  const box = document.getElementById("matches");
  box.innerHTML="";
  Object.values(matches).forEach(m=>{
    box.innerHTML += `
      <div class="match">
        ${m.creator}
        <br><br>
        <button onclick="joinMatch(${m.id})">Join</button>
      </div>`;
  });
}

/* JOIN */
function joinMatch(id){
  pubnub.subscribe({channels:["match-"+id]});
  const r = Math.random()<0.5?"H":"T";
  pubnub.publish({
    channel:"match-"+id,
    message:{r,w:user}
  });
  pubnub.publish({channel:"matches",message:{type:"remove",id}});
}
</script>

</body>
</html>
